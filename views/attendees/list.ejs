<% layout('layouts/main') -%>

<h1 class="mb-3">Attendees</h1>

<!-- 🔍 Search Input -->
<div class="mb-3">
  <input
    type="text"
    id="searchInput"
    class="form-control"
    placeholder="Search attendee by name, type, or card number..."
  >
</div>

<table class="table table-sm table-bordered table-hover align-middle text-nowrap">
  <thead class="table-light">
    <tr>
      <th style="width:50px;">S/N</th>
      <th>Name</th>
      <th>Type</th>
      <th>Phone</th>
      <!-- <th>Card No</th> -->
      <th>Scans</th>
      <!-- <th>QR</th> -->
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="attendeesTable">
    <% guests.forEach((g, i) => { %>
      <tr>
        <td class="sn-col"><%= i + 1 %></td>
        <td><%= g.name %></td>
        <td><%= g.type %></td>
        <td><%= g.phone || '-' %></td>
        <!-- <td><%= g.card_number || '-' %></td> -->
        <td><%= g.scans %></td>
        <!-- <td>
          <% if (g.qr_code_path) { %>
            <img src="/<%= g.qr_code_path.replace(/^public\//,'') %>" style="width:32px;height:32px" class="rounded"/>
          <% } %>
        </td> -->
        <td class="d-flex gap-1 flex-wrap">
          <a class="btn btn-sm btn-outline-secondary py-0 px-2" title="Edit" href="/attendees/<%= g.id %>/edit">
            <i class="bi bi-pencil-square"></i>
          </a>
          <a class="btn btn-sm btn-outline-success py-0 px-2" title="Download" href="/attendees/<%= g.id %>/download">
            <i class="bi bi-download"></i>
          </a>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<!-- Pagination controls -->
<nav>
  <ul class="pagination justify-content-center" id="pagination"></ul>
</nav>

<!-- Message when no results found -->
<p id="noResults" class="text-center text-muted d-none">No attendees found.</p>

<!-- 💡 Client-side Script -->
<script>
  const searchInput = document.getElementById('searchInput');
  const table = document.getElementById('attendeesTable');
  const rows = Array.from(table.querySelectorAll('tr'));
  const pagination = document.getElementById('pagination');
  const noResults = document.getElementById('noResults');

  const rowsPerPage = 10;
  let currentPage = 1;
  let filteredRows = rows;

  function renderTable() {
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    rows.forEach(row => row.style.display = 'none');
    filteredRows.slice(start, end).forEach((row, index) => {
      row.style.display = '';
      // Update S/N dynamically for visible rows
      row.querySelector('.sn-col').textContent = start + index + 1;
    });

    renderPagination();
    noResults.classList.toggle('d-none', filteredRows.length > 0);
  }

  function renderPagination() {
    pagination.innerHTML = '';
    const pageCount = Math.ceil(filteredRows.length / rowsPerPage);
    if (pageCount <= 1) return;

    for (let i = 1; i <= pageCount; i++) {
      const li = document.createElement('li');
      li.className = `page-item ${i === currentPage ? 'active' : ''}`;
      li.innerHTML = `<button class="page-link">${i}</button>`;
      li.addEventListener('click', () => {
        currentPage = i;
        renderTable();
      });
      pagination.appendChild(li);
    }
  }

  searchInput.addEventListener('keyup', function () {
    const term = this.value.toLowerCase().trim();
    filteredRows = rows.filter(row => row.textContent.toLowerCase().includes(term));
    currentPage = 1;
    renderTable();
  });

  renderTable();
</script>

<!-- Bootstrap Icons CDN -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
/>
